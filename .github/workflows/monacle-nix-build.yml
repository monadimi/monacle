name: build only (nix pinned node + next build)

on:
  push:
    branches: [ "dev", "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    env:
      NIX_CONFIG: experimental-features = nix-command flakes
      NODE_ENV: production

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v30
        with:
          extra_nix_config: |
            experimental-features = nix-command flakes
            accept-flake-config = true

      - name: Nix build monacle-run
        working-directory: infra
        run: |
          set -euo pipefail
          nix build -L .#monacle-run

      - name: Build pinned node and add to PATH
        working-directory: infra
        run: |
          set -euo pipefail
          nix build -L .#nodejs_20_20_0 -o ./node
          echo "$PWD/node/bin" >> "$GITHUB_PATH"

      - name: Debug node/npm
        run: |
          set -euo pipefail
          which node
          which npm
          node -v
          npm -v

      - name: Next build
        run: |
          set -euo pipefail
          npm ci --include=dev
          npm run build