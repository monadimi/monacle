[Unit]
Description=monacle (Next.js) via Nix Node.js 20.20.0
Wants=network-online.target
After=network-online.target

[Service]
Type=simple
User=monad
Group=monad

Environment="PORT=3000"
Environment=NODE_ENV=production
Environment="NIX_CONFIG=experimental-features = nix-command flakes"
EnvironmentFile=/etc/monacle/monacle.env

# infra checkout 위치 (systemd WorkingDirectory와는 별개)
Environment="INFRA_REPO=https://github.com/monadimi/monacle.git"
Environment="INFRA_BRANCH=main"
Environment="INFRA_ROOT=/home/monad/apps/monacle/infra-src"
Environment="INFRA_DIR=/home/monad/apps/monacle/infra-src/infra"

WorkingDirectory=/home/monad/apps/monacle

ExecStartPre=/usr/bin/bash -lc 'set -euo pipefail; \
  umask 022; \
  if [ ! -d "$INFRA_ROOT/.git" ]; then \
    rm -rf "$INFRA_ROOT"; \
    /usr/bin/git clone --depth 1 --branch "$INFRA_BRANCH" "$INFRA_REPO" "$INFRA_ROOT"; \
  else \
    cd "$INFRA_ROOT"; \
    /usr/bin/git fetch origin "$INFRA_BRANCH" --depth 1; \
    /usr/bin/git reset --hard "origin/$INFRA_BRANCH"; \
    /usr/bin/git clean -fd; \
  fi; \
  /nix/var/nix/profiles/default/bin/nix build "$INFRA_DIR"#monacle-run --out-link /home/monad/apps/monacle/nix-monacle \
'

ExecStart=/usr/bin/bash -lc 'set -euo pipefail; exec /home/monad/apps/monacle/nix-monacle/bin/monacle-run'

Restart=always
RestartSec=3

NoNewPrivileges=true
PrivateTmp=true
ProtectSystem=strict
ProtectHome=false
LockPersonality=true
RestrictRealtime=true
RestrictSUIDSGID=true

UMask=0077
ReadWritePaths=/home/monad/apps/monacle /var/cache/monacle /var/log/monacle /home/monad/apps/monacle/infra-src

[Install]
WantedBy=multi-user.target